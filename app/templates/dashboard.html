<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Factory | Neural Dashboard</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg-deep: #0f172a;
            --accent-blue: #38bdf8;
            --accent-green: #22c55e;
        }

        body {
            font-family: 'Ubuntu', sans-serif;
            background-color: var(--bg-deep);
            color: #f8fafc;
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-dock {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(56, 189, 248, 0.3);
        }

        /* Animated Worker Card */
        .worker-card {
            background-image: linear-gradient(to bottom, rgba(15, 23, 42, 0.2), rgba(15, 23, 42, 0.9)),
                url("https://images.unsplash.com/photo-1581092160562-40aa08e78837");
            background-size: cover;
            background-position: center;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .worker-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-blue);
        }

        .stat-value {
            text-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
        }

        /* Search Glow */
        #searchBox:focus {
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
            outline: none;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col">
    <div class="flex-shrink-0 bg-inherit z-40 px-6 pt-6 pb-4 border-b border-slate-800">



        <nav class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight flex items-center gap-3">
                    <span class="material-symbols-rounded text-sky-400 text-4xl">precision_manufacturing</span>
                    Productivity Dashboard <span class="text-sky-400">Biz-Tech Analytics</span>
                </h1>
                <p class="text-slate-400 text-sm ml-12">AI-Powered Worker Productivity Monitoring System</p>
            </div>

            <div class="relative group">
                <span
                    class="material-symbols-rounded absolute left-3 top-2.5 text-slate-400 group-focus-within:text-sky-400 transition-colors">search</span>
                <input id="searchBox" type="text" placeholder="Search workers or stations..."
                    class="bg-slate-800/50 border border-slate-700 pl-11 pr-4 py-2.5 rounded-full w-80 text-sm focus:border-sky-500 transition-all">
            </div>
        </nav>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-10">
            <div class="glass-panel p-5 rounded-2xl flex items-center gap-4">
                <div class="p-3 bg-sky-500/10 rounded-xl text-sky-400">
                    <span class="material-symbols-rounded">schedule</span>
                </div>
                <div>
                    <p class="text-xs text-slate-400 uppercase tracking-wider font-bold">Active Hours</p>
                    <p class="text-2xl font-bold stat-value">{{ factory.total_active_hours }}</p>
                </div>
            </div>

            <div class="glass-panel p-5 rounded-2xl flex items-center gap-4">
                <div class="p-3 bg-emerald-500/10 rounded-xl text-emerald-400">
                    <span class="material-symbols-rounded">inventory_2</span>
                </div>
                <div>
                    <p class="text-xs text-slate-400 uppercase tracking-wider font-bold">Total Units</p>
                    <p class="text-2xl font-bold stat-value">{{ factory.total_units }}</p>
                </div>
            </div>

            <div class="glass-panel p-5 rounded-2xl flex items-center gap-4">
                <div class="p-3 bg-amber-500/10 rounded-xl text-amber-400">
                    <span class="material-symbols-rounded">analytics</span>
                </div>
                <div>
                    <p class="text-xs text-slate-400 uppercase tracking-wider font-bold">Utilization</p>
                    <p class="text-2xl font-bold stat-value">{{ factory.avg_utilization }}%</p>
                </div>
            </div>

            <div class="glass-panel p-5 rounded-2xl flex items-center gap-4">
                <div class="p-3 bg-purple-500/10 rounded-xl text-purple-400">
                    <span class="material-symbols-rounded">speed</span>
                </div>
                <div>
                    <p class="text-xs text-slate-400 uppercase tracking-wider font-bold">Avg Rate</p>
                    <p class="text-2xl font-bold stat-value">{{ factory.avg_rate }}</p>
                </div>
            </div>
        </div>
    </div>
    <div class="flex-1 overflow-y-auto px-6 py-6 custom-scroll">


        <div class="xl:col-span-2">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="material-symbols-rounded text-sky-400">engineering</span> Workers
                </h2>
                <span id="healthBadge"
                    class="text-xs bg-slate-800 px-3 py-1 rounded-full text-slate-400 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-gray-400" id="healthDot"></span>
                    System Checking
                </span>

            </div>

            <div id="workersGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for w in workers %}
                <div class="worker-card rounded-2xl h-56 relative overflow-hidden border border-slate-800 worker-item"
                    data-name="{{w.name}}">
                    <div class="absolute inset-0 p-5 flex flex-col justify-between">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-bold">{{ w.name }}</h3>
                                <p class="text-xs text-sky-300">ID: #{{ loop.index + 100 }}</p>
                            </div>
                            <span
                                class="px-2 py-1 rounded bg-green-500/20 text-green-400 text-[10px] font-bold">ONLINE</span>
                        </div>

                        <div class="grid grid-cols-3 gap-2 text-center bg-black/40 backdrop-blur-md rounded-xl p-3">
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase">UPH</p>
                                <p class="font-bold text-sm">{{ w.uph }}</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase">Units</p>
                                <p class="font-bold text-sm">{{ w.units }}</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase">Active</p>
                                <p class="font-bold text-sm">{{ w.active_hours }}h</p>
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between text-[10px] mb-1 px-1">
                                <span>Utilization</span>
                                <span>{{ 100 if w.utilization > 100 else w.utilization }}%</span>
                            </div>
                            <div class="w-full bg-white/10 rounded-full h-1.5 overflow-hidden">
                                <div class="bg-sky-400 h-full rounded-full transition-all duration-1000"
                                    style="width:{{ 100 if w.utilization>100 else w.utilization }}%">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div>
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="material-symbols-rounded text-sky-400">layers</span> Workstations
                </h2>
            </div>

            <div id="stationsGrid" class="space-y-4">
                {% for s in stations %}
                <div class="glass-panel p-4 rounded-xl border-l-4 border-l-sky-500 station-item" data-name="{{s.name}}">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-slate-200">{{ s.name }}</h3>
                        <span class="text-xs font-mono text-sky-400">{{ s.utilization }}% Load</span>
                    </div>

                    <div class="flex gap-4 text-xs text-slate-400">
                        <span class="flex items-center gap-1"><span
                                class="material-symbols-rounded text-[14px]">token</span> {{ s.units }} units</span>
                        <span class="flex items-center gap-1"><span
                                class="material-symbols-rounded text-[14px]">bolt</span> {{ s.throughput }} t/p</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div
        class="glass-dock fixed bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-8 px-6 py-3 rounded-2xl shadow-2xl z-50">
        <button onclick="toggleTheme()" class="hover:text-sky-400 transition-colors flex flex-col items-center gap-0.5">
            <span class="material-symbols-rounded">contrast</span>
            <span class="text-[10px] font-medium uppercase">Theme</span>
        </button>
        <button onclick="location.reload()"
            class="hover:text-sky-400 transition-colors flex flex-col items-center gap-0.5">
            <span class="material-symbols-rounded">sync</span>
            <span class="text-[10px] font-medium uppercase">Sync</span>
        </button>
        <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
            class="hover:text-sky-400 transition-colors flex flex-col items-center gap-0.5">
            <span class="material-symbols-rounded">expand_less</span>
            <span class="text-[10px] font-medium uppercase">Top</span>
        </button>
    </div>

    <script>
        const html = document.documentElement;

        function toggleTheme() {
            html.classList.toggle("dark");
            // If we go to light mode, we adjust the deep background manually
            if (!html.classList.contains('dark')) {
                document.body.style.backgroundColor = "#f1f5f9";
                document.body.style.color = "#0f172a";
            } else {
                document.body.style.backgroundColor = "";
                document.body.style.color = "";
            }
        }

        /* SEARCH FILTER WITH ANIMATION */
        document.getElementById("searchBox").addEventListener("input", function () {
            let val = this.value.toLowerCase();

            const filterItems = (selector) => {
                document.querySelectorAll(selector).forEach(el => {
                    const matches = el.dataset.name.toLowerCase().includes(val);
                    if (matches) {
                        el.style.display = "block";
                        el.style.opacity = "1";
                    } else {
                        el.style.display = "none";
                        el.style.opacity = "0";
                    }
                });
            };

            filterItems(".worker-item");
            filterItems(".station-item");
        });

    </script>
    <script>
        /* ---------------------------
           AJAX METRICS REFRESH
        ----------------------------*/

        async function refreshMetrics() {

            try {
                const workers = await fetch("/api/metrics/workers").then(r => r.json());
                const factory = await fetch("/api/metrics/factory").then(r => r.json());

                document.querySelectorAll(".stat-value")[0].innerText = factory.total_active_hours;
                document.querySelectorAll(".stat-value")[1].innerText = factory.total_units;
                document.querySelectorAll(".stat-value")[2].innerText = factory.avg_utilization + "%";
                document.querySelectorAll(".stat-value")[3].innerText = factory.avg_rate;

            } catch (err) {
                console.error("Metrics refresh failed:", err);
            }
        }

        async function checkHealth() {

            try {
                const res = await fetch("/health");
                const data = await res.json();

                const badge = document.getElementById("healthBadge");

                badge.innerHTML = `
                <span class="w-2 h-2 rounded-full bg-green-400"></span>
                CPU ${data.cpu_usage}% | RAM ${data.ram_usage_percent}%`;

            } catch (err) {
                document.getElementById("healthBadge").innerHTML =
                    `<span class="w-2 h-2 rounded-full bg-red-500"></span> Offline`;
            }
        }


        refreshMetrics();
        checkHealth();


        /* ---------------------------
           HEALTH CHECK STATUS
        ----------------------------*/

        async function checkHealth() {
            try {
                const res = await fetch("/health");
                const data = await res.json();

                const badge = document.getElementById("healthBadge");
                const dot = document.getElementById("healthDot");

                if (data.status === "ok") {
                    badge.innerHTML = `<span id="healthDot" class="w-2 h-2 rounded-full bg-green-400"></span> System Healthy`;
                } else {
                    badge.innerHTML = `<span id="healthDot" class="w-2 h-2 rounded-full bg-yellow-400"></span> Degraded`;
                }

            } catch (err) {
                const badge = document.getElementById("healthBadge");
                badge.innerHTML = `<span id="healthDot" class="w-2 h-2 rounded-full bg-red-500"></span> Offline`;
            }
        }

        /* ---------------------------
           SCHEDULERS
        ----------------------------*/

        setInterval(refreshMetrics, 30000);
        setInterval(checkHealth, 15000);

        // Run immediately on load
        refreshMetrics();
        checkHealth();
    </script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        const socket = io();

        socket.on("live_update", data => {

            // Factory cards
            document.querySelectorAll(".stat-value")[0].innerText =
                data.factory.total_active_hours;

            document.querySelectorAll(".stat-value")[1].innerText =
                data.factory.total_units;

            document.querySelectorAll(".stat-value")[2].innerText =
                data.factory.avg_utilization + "%";

            document.querySelectorAll(".stat-value")[3].innerText =
                data.factory.avg_rate;

            // Health badge
            document.getElementById("healthBadge").innerHTML =
                `<span class="w-2 h-2 rounded-full bg-green-400"></span>
     CPU ${data.health.cpu}% | RAM ${data.health.ram}%`;

        });
    </script>
</body>

</html>